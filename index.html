<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T√™te d'Or - Arcade Football</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        // Importation des fonctions n√©cessaires
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ta configuration Firebase sp√©cifique
        const firebaseConfig = {
            apiKey: "AIzaSyCJrobm_byf7r409nRnikVHc1VDlmJ7FY0",
            authDomain: "tete-d-or.firebaseapp.com",
            projectId: "tete-d-or",
            storageBucket: "tete-d-or.firebasestorage.app",
            messagingSenderId: "751725321702",
            appId: "1:751725321702:web:9b1c9d8eda3dae0c758a27",
            measurementId: "G-D6D3WDYQ04"
        };

        // On expose ces modules √† la fen√™tre globale pour que le script du jeu puisse les utiliser
        window.firebaseModules = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            orderBy, 
            limit, 
            firebaseConfig 
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap');
        body { font-family: 'Nunito', sans-serif; overflow: hidden; touch-action: none; background-color: #222; user-select: none; -webkit-user-select: none; }
        h1, h2, .arcade-font { font-family: 'Fredoka One', cursive; }
        .bg-field { background: radial-gradient(circle at center, #4ade80 0%, #16a34a 60%, #14532d 100%); }
        #gameCanvas { display: block; width: 100%; height: 100%; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3); }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        .interactive { pointer-events: auto; }
        .hidden { display: none !important; }
        input[type="file"] { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 4px solid #f9fafb; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border-radius: 1.5rem; max-height: 90vh; overflow-y: auto; transition: all 0.3s ease; }
        .btn-primary { transition: all 0.1s ease-out; border-bottom: 4px solid #15803d; background-image: linear-gradient(to bottom, #4ade80, #22c55e); text-shadow: 1px 1px 0px rgba(0,0,0,0.1); }
        .btn-primary:active { transform: translateY(2px); border-bottom: 0px solid #15803d; margin-top: 2px; margin-bottom: 2px; }
        .face-preview-wrapper { position: relative; width: 100px; height: 100px; margin: 0 auto; }
        .face-mask-clip { width: 100%; height: 100%; clip-path: ellipse(45% 55% at 50% 50%); background-color: #e5e7eb; overflow: hidden; position: relative; }
        .face-mask-clip img { width: 100%; height: 100%; object-fit: cover; }
        .face-guide-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { max-height: 80vh; overflow-y: auto; }
        .color-option { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; border: 3px solid rgba(255,255,255,0.8); box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.2s, border-color 0.2s; }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border: 3px solid #000; transform: scale(1.15); box-shadow: 0 0 0 2px rgba(255,255,255,1); }
        .main-tabs { display: flex; background: #e5e7eb; border-radius: 1rem 1rem 0 0; padding: 4px 4px 0 4px; margin-bottom: 0; }
        .main-tab-btn { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 800; color: #6b7280; border-radius: 0.8rem 0.8rem 0 0; transition: all 0.2s; font-family: 'Fredoka One', cursive; font-size: 1.1rem; }
        .main-tab-btn.active { background: white; color: #16a34a; box-shadow: 0 -4px 6px rgba(0,0,0,0.05); }
        .tab-content { display: none; padding: 1.5rem; background: white; border-radius: 0 0 1.5rem 1.5rem; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 0.85rem; font-weight: 800; text-transform: uppercase; color: #9ca3af; letter-spacing: 0.05em; margin-bottom: 0.5rem; text-align: left; }
    </style>
</head>
<body class="bg-field text-slate-800">

    <canvas id="gameCanvas"></canvas>

    <div id="startScreen" class="ui-layer interactive">
        <div class="max-w-md w-[95%]">
            <h1 class="text-5xl text-white text-center mb-6 arcade-font drop-shadow-[0_4px_0_rgba(0,0,0,0.3)] stroke-black" style="-webkit-text-stroke: 1px rgba(0,0,0,0.2);">T√äTE D'OR</h1>

            <div class="glass-panel !p-0 !bg-transparent !border-0 !shadow-2xl">
                <div class="main-tabs">
                    <div id="tabMatch" class="main-tab-btn active" onclick="switchMainTab('match')">‚öΩ MATCH</div>
                    <div id="tabVestiaire" class="main-tab-btn" onclick="switchMainTab('vestiaire')">üëï VESTIAIRE</div>
                </div>

                <div id="contentMatch" class="tab-content active">
                    <div class="mb-6 text-center">
                        <p class="text-gray-500 mb-2">Pr√™t pour le coup d'envoi ?</p>
                        <div class="p-4 bg-green-50 rounded-xl border border-green-100 mb-4">
                            <input type="text" id="playerNameInput" placeholder="Ton nom de joueur" class="w-full p-3 border-2 border-gray-200 rounded-lg text-center font-bold text-lg focus:border-green-500 focus:outline-none transition bg-white text-gray-700" maxlength="15">
                        </div>
                    </div>
                    <div class="flex flex-col gap-3">
                        <button id="startBtn" class="w-full btn-primary text-white text-2xl py-4 rounded-xl font-bold shadow-lg transition arcade-font">JOUER</button>
                        <div class="flex gap-3 mt-2">
                            <button id="showScoresBtn" class="flex-1 bg-white border-2 border-gray-200 hover:border-blue-400 text-gray-700 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-sm">üèÜ Scores</button>
                            <button id="toggleMusicBtn" class="flex-1 bg-white border-2 border-gray-200 hover:border-purple-400 text-gray-700 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-sm">üéµ Musique</button>
                        </div>
                    </div>
                </div>

                <div id="contentVestiaire" class="tab-content">
                    <div class="flex items-center gap-4 mb-6 p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('photoInput').click()">
                            <div class="face-preview-wrapper">
                                <div class="face-mask-clip shadow-md bg-white">
                                    <img id="facePreview" src="" alt="Visage" class="hidden">
                                    <div id="placeholderFace" class="w-full h-full flex items-center justify-center text-4xl text-gray-300">üë§</div>
                                </div>
                                <svg class="face-guide-overlay" viewBox="0 0 100 100" preserveAspectRatio="none"><ellipse cx="50" cy="50" rx="45" ry="55" fill="none" stroke="#cbd5e1" stroke-width="2" stroke-dasharray="4,4" /></svg>
                            </div>
                            <input type="file" id="photoInput" accept="image/*" capture="user">
                        </div>
                        <div class="text-sm text-gray-500 flex-1"><strong class="text-gray-800 block mb-1">Ton Visage</strong>Clique sur l'ovale pour ajouter ta photo.</div>
                    </div>
                    <div class="space-y-5">
                        <div><div class="section-title">Couleur de Peau</div><div class="flex gap-3 overflow-x-auto pb-2" id="skinColors"></div></div>
                        <div><div class="section-title">Maillot</div><div class="flex gap-3 overflow-x-auto pb-2" id="jerseyColors"></div></div>
                        <div><div class="section-title">Short</div><div class="flex gap-3 overflow-x-auto pb-2" id="shortsColors"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="hudLayer" class="ui-layer hidden !justify-start !items-start p-4">
        <div class="flex justify-between w-full items-start">
            <div class="text-5xl text-white font-black drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] arcade-font stroke-black" style="-webkit-text-stroke: 2px black;"><span id="scoreDisplay">0</span></div>
            <div class="flex flex-col items-end gap-2">
                <div id="levelDisplay" class="text-xl text-yellow-300 font-bold drop-shadow-lg bg-black/60 px-4 py-1 rounded-full border border-white/20">NIVEAU 1</div>
                <button id="muteBtnGame" class="bg-black/40 text-white p-2 rounded-full hover:bg-black/60 transition backdrop-blur-sm">üîä</button>
            </div>
        </div>
    </div>

    <div id="gameOverScreen" class="ui-layer interactive hidden">
        <div class="glass-panel p-8 max-w-sm w-[90%] text-center">
            <h2 class="text-5xl text-red-500 mb-2 arcade-font drop-shadow-sm">FIN DU MATCH</h2>
            <p class="text-gray-500 text-sm uppercase font-bold tracking-widest mb-6">Coup de sifflet final</p>
            <div class="bg-gray-100 rounded-xl p-4 mb-6">
                 <p class="text-gray-500 text-sm">Score Final</p>
                 <span id="finalScore" class="font-black text-6xl text-slate-800">0</span>
            </div>
            <button id="restartBtn" class="w-full btn-primary bg-blue-500 text-white text-xl py-3 rounded-xl font-bold shadow-lg transition mb-3 arcade-font">REJOUER</button>
            <button id="changeFaceBtn" class="w-full bg-white border-2 border-gray-200 hover:bg-gray-50 text-gray-700 text-lg py-2 rounded-xl font-bold transition">Menu Principal</button>
        </div>
    </div>

    <div id="scoresModal" class="modal hidden interactive">
        <div class="glass-panel modal-content p-0 max-w-lg w-[90%] text-center overflow-hidden">
            <div class="bg-blue-600 text-white p-4"><h2 class="text-2xl arcade-font">CLASSEMENT</h2></div>
            <div class="flex border-b bg-gray-50">
                <div id="tabLocal" class="tab-btn p-3 flex-1 font-bold text-gray-500 cursor-pointer border-b-4 border-transparent hover:bg-gray-100" onclick="switchTab('local')">LOCAL</div>
                <div id="tabWorld" class="tab-btn p-3 flex-1 font-bold text-gray-500 cursor-pointer border-b-4 border-transparent hover:bg-gray-100" onclick="switchTab('world')">MONDE üåç</div>
            </div>
            <div id="scoresTable" class="text-left min-h-[250px] p-0 bg-white"></div>
            <div class="p-4 border-t"><button id="closeScoresModal" class="w-full bg-red-100 hover:bg-red-200 text-red-600 text-lg py-2 rounded-xl font-bold transition">Fermer</button></div>
        </div>
    </div>

    <script>
        /** --- FIREBASE ENGINE --- **/
        let db, auth;
        let isFirebaseReady = false;

        async function initFirebase() {
            try {
                if (window.firebaseModules) {
                    const { initializeApp, getAuth, signInAnonymously, getFirestore, firebaseConfig } = window.firebaseModules;
                    
                    // Initialisation avec ta configuration
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    // Connexion anonyme pour pouvoir √©crire dans la base
                    await signInAnonymously(auth);
                    
                    isFirebaseReady = true;
                    console.log("Firebase connect√© au projet T√™te d'Or !");
                }
            } catch (e) {
                console.error("Erreur Firebase:", e);
            }
        }
        initFirebase();

        /** --- AUDIO ENGINE --- **/
        const AudioEngine = {
            ctx: null, isPlaying: false, osc: null, gain: null, nextNoteTime: 0, noteIndex: 0, tempo: 0.15,
            melody: [261.63, 261.63, 293.66, 261.63, 349.23, 329.63, 0, 261.63, 261.63, 293.66, 261.63, 392.00, 349.23, 0, 329.63, 329.63, 440.00, 392.00, 349.23, 329.63, 293.66, 0],
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            toggle() {
                this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                this.isPlaying = !this.isPlaying;
                if (this.isPlaying) { this.nextNoteTime = this.ctx.currentTime; this.scheduler(); } 
                else { if(this.osc) { this.osc.stop(); this.osc.disconnect(); this.osc = null; } clearTimeout(this.timerID); }
                return this.isPlaying;
            },
            playTone(freq, time) {
                if(freq <= 0) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square'; osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.05, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(time); osc.stop(time + 0.15);
            },
            scheduler() {
                if (!this.isPlaying) return;
                while (this.nextNoteTime < this.ctx.currentTime + 0.1) {
                    this.playTone(this.melody[this.noteIndex % this.melody.length], this.nextNoteTime);
                    this.nextNoteTime += this.tempo;
                    this.noteIndex++;
                }
                this.timerID = setTimeout(() => this.scheduler(), 25);
            }
        };

        /** --- GAME CONFIG --- **/
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const hudLayer = document.getElementById('hudLayer');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const finalScoreDisplay = document.getElementById('finalScore');
        const photoInput = document.getElementById('photoInput');
        const facePreview = document.getElementById('facePreview');
        const placeholderFace = document.getElementById('placeholderFace');
        const levelDisplay = document.getElementById('levelDisplay');
        const playerNameInput = document.getElementById('playerNameInput');
        const toggleMusicBtn = document.getElementById('toggleMusicBtn');
        const muteBtnGame = document.getElementById('muteBtnGame');

        let gameRunning = false, score = 0, animationId, lastTime = 0, difficultyLevel = 1, userFaceImage = null, playerHitTimer = 0;
        const GRAVITY = 0.55, AIR_RESISTANCE = 0.99, BOUNCE_FORCE = -15, PLAYER_RECOIL_FORCE = 15, PLAYER_SMOOTHING_FACTOR = 0.5;
        let player = { x: 0, y: 0, width: 80, height: 140, headRadius: 35, vx: 0, jerseyColor: '#3b82f6', shortsColor: '#ffffff', skinColor: '#fca5a5' };
        let ball = { x: 0, y: 0, radius: 20, vx: 0, vy: 0, rotation: 0 };
        let obstacles = [], particles = [];
        const skinColors = ['#fca5a5', '#e0ac69', '#aa724b', '#5c3a21', '#fde047', '#eeccab', '#3b2f2f'];
        const jerseyColors = ['#3b82f6', '#ef4444', '#22c55e', '#eab308', '#a855f7', '#111827', '#ffffff'];
        const shortsColors = ['#ffffff', '#1f2937', '#3b82f6', '#ef4444', '#000000'];

        function initCustomizationUI() {
            const createOptions = (colors, containerId, prop) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                colors.forEach(color => {
                    const el = document.createElement('div');
                    el.className = `color-option ${color === player[prop] ? 'selected' : ''}`;
                    el.style.backgroundColor = color;
                    el.onclick = () => { player[prop] = color; updateSelection(container, el); };
                    container.appendChild(el);
                });
            };
            createOptions(skinColors, 'skinColors', 'skinColor');
            createOptions(jerseyColors, 'jerseyColors', 'jerseyColor');
            createOptions(shortsColors, 'shortsColors', 'shortsColor');
        }
        function updateSelection(container, selectedEl) { Array.from(container.children).forEach(c => c.classList.remove('selected')); selectedEl.classList.add('selected'); }
        window.switchMainTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.main-tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('content' + (tabName.charAt(0).toUpperCase() + tabName.slice(1))).classList.add('active');
            document.getElementById('tab' + (tabName.charAt(0).toUpperCase() + tabName.slice(1))).classList.add('active');
        };
        function setPlayerY() { player.y = canvas.height - 40; }
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; setPlayerY(); if (!gameRunning) player.x = canvas.width / 2; }
        window.addEventListener('resize', resize);
        
        function updateMusicButtonUI() {
            toggleMusicBtn.innerHTML = AudioEngine.isPlaying ? "üéµ ON" : "üéµ OFF";
            toggleMusicBtn.classList.toggle('bg-purple-100', AudioEngine.isPlaying); toggleMusicBtn.classList.toggle('text-purple-600', AudioEngine.isPlaying); toggleMusicBtn.classList.toggle('border-purple-300', AudioEngine.isPlaying);
            muteBtnGame.textContent = AudioEngine.isPlaying ? "üîä" : "üîá";
        }
        toggleMusicBtn.addEventListener('click', () => { AudioEngine.toggle(); updateMusicButtonUI(); });
        muteBtnGame.addEventListener('click', () => { AudioEngine.toggle(); updateMusicButtonUI(); });

        function initGame() {
            score = 0; difficultyLevel = 1; scoreDisplay.textContent = "0";
            levelDisplay.textContent = "NIVEAU 1"; levelDisplay.className = "text-xl text-yellow-300 font-bold drop-shadow-lg bg-black/40 px-4 py-1 rounded-full";
            player.x = canvas.width / 2; setPlayerY(); resetBall(); obstacles = []; particles = []; gameRunning = true; lastTime = performance.now();
        }

        function resetBall() {
            const side = Math.random() < 0.5 ? 'left' : 'right';
            ball.x = side === 'left' ? -30 : canvas.width + 30; ball.y = canvas.height / 3; 
            const speedX = 6 + Math.random() * 4; ball.vx = side === 'left' ? speedX : -speedX; ball.vy = -8 - Math.random() * 5; ball.rotation = 0;
        }

        function masterLoop(timestamp) {
            const dt = timestamp - lastTime; lastTime = timestamp;
            if (gameRunning) update(); else player.x += (canvas.width / 2 - player.x) * 0.1;
            draw(); animationId = requestAnimationFrame(masterLoop);
        }

        function update() {
            ball.vy += GRAVITY; ball.vx *= AIR_RESISTANCE; ball.x += ball.vx; ball.y += ball.vy; ball.rotation += ball.vx * 0.05;
            if (ball.x - ball.radius < 0) { ball.x = ball.radius; ball.vx *= -0.8; } 
            else if (ball.x + ball.radius > canvas.width) { ball.x = canvas.width - ball.radius; ball.vx *= -0.8; }
            if (ball.y - ball.radius > canvas.height - 40) { endGame(); }

            const headCenterY = player.y - 155; 
            const dx = ball.x - player.x; const dy = ball.y - headCenterY;
            const distance = Math.sqrt(dx*dx + dy*dy); const minDist = ball.radius + player.headRadius * 0.8; 

            if (distance < minDist && ball.vy > 0) { 
                const impactRatio = dx / (player.headRadius * 1.5); 
                ball.vy = BOUNCE_FORCE; ball.vx = impactRatio * 15; ball.y = headCenterY - minDist - 2; 
                score++; scoreDisplay.textContent = score;
                createParticles(ball.x, ball.y + ball.radius, 15, '#ffffff', 5); createParticles(ball.x, ball.y + ball.radius, 7, '#fbbf24', 3);
                checkDifficulty();
            }
            if(playerHitTimer > 0) playerHitTimer--;
            if (Math.random() < 0.008 * difficultyLevel) spawnObstacle();

            obstacles.forEach((obs, index) => {
                obs.x += obs.vx; obs.y += obs.vy; obs.rotation += obs.rotSpeed;
                if (obs.x < -100 || obs.x > canvas.width + 100 || obs.y > canvas.height + 100) { obstacles.splice(index, 1); return; }
                const dxB = ball.x - obs.x; const dyB = ball.y - obs.y;
                if (Math.sqrt(dxB * dxB + dyB * dyB) < ball.radius + 20) { 
                    createParticles(ball.x, ball.y, 8, '#9ca3af', 3); ball.vx = (Math.random() - 0.5) * 25; ball.vy = (Math.random() - 0.5) * 20; obstacles.splice(index, 1); return;
                }
                const playerBodyTop = player.y - 140; const playerBodyBottom = player.y - 5;
                if (obs.x > player.x - 30 && obs.x < player.x + 30 && obs.y > playerBodyTop && obs.y < playerBodyBottom) {
                    if (playerHitTimer === 0) { createParticles(obs.x, obs.y, 15, '#ef4444', 4); player.vx = obs.vx > 0 ? -PLAYER_RECOIL_FORCE : PLAYER_RECOIL_FORCE; playerHitTimer = 30; setTimeout(() => player.vx = 0, 100); }
                    obstacles.splice(index, 1); return;
                }
            });
            player.x += player.vx; if (player.x < 40) player.x = 40; if (player.x > canvas.width - 40) player.x = canvas.width - 40;
            particles.forEach((p, index) => { p.x += p.vx; p.y += p.vy; p.life--; p.alpha = p.life / 30; p.radius *= 0.95; if (p.life <= 0) particles.splice(index, 1); });
        }

        function checkDifficulty() {
            const newLevel = Math.min(10, Math.floor(score / 10) + 1);
            if (newLevel !== difficultyLevel) {
                difficultyLevel = newLevel; levelDisplay.textContent = "NIVEAU " + difficultyLevel;
                const levelColors = ['text-yellow-300', 'text-orange-400', 'text-red-500', 'text-pink-500', 'text-purple-500', 'text-indigo-400', 'text-cyan-300', 'text-lime-300', 'text-amber-500', 'text-rose-600'];
                levelDisplay.className = `text-xl font-bold drop-shadow-lg bg-black/40 px-4 py-1 rounded-full ${levelColors[newLevel - 1]}`;
            }
        }

        function spawnObstacle() {
            const side = Math.random() < 0.5 ? 'left' : 'right';
            const r = Math.random(); let type = r < 0.25 ? 'card_red' : r < 0.5 ? 'card_yellow' : r < 0.7 ? 'boot' : r < 0.85 ? 'whistle' : 'bottle';
            const baseSpeed = 3; const speedMultiplier = 1 + (difficultyLevel - 1) * 0.4;
            obstacles.push({ type: type, x: side === 'left' ? -30 : canvas.width + 30, y: Math.random() * (canvas.height - 250) + 50, vx: side === 'left' ? (baseSpeed + Math.random() * speedMultiplier) : -(baseSpeed + Math.random() * speedMultiplier), vy: (Math.random() - 0.5) * 2, rotation: 0, rotSpeed: (Math.random() - 0.5) * 0.15 });
        }

        function draw() {
            ctx.fillStyle = '#10b981'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(canvas.width / 2, canvas.height - 40); ctx.lineTo(canvas.width / 2, 0); ctx.stroke();
            ctx.beginPath(); ctx.arc(canvas.width / 2, canvas.height - 40, 100, Math.PI, Math.PI * 2, false); ctx.stroke();
            ctx.fillStyle = '#059669'; ctx.fillRect(0, canvas.height - 40, canvas.width, 40);
            if (playerHitTimer % 6 < 3) drawPlayer();
            if (gameRunning) {
                obstacles.forEach(drawObstacle); drawBall();
                particles.forEach(p => { ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1; });
            }
        }

        function drawPlayer() {
            const centerX = player.x; const groundY = player.y;
            ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(centerX, groundY, 35, 10, 0, 0, Math.PI * 2); ctx.fill();
            const bootTopY = groundY - 10; const legTopY = bootTopY - 50; const shortsBottomY = legTopY + 10; const shortsTopY = shortsBottomY - 30; const jerseyTopY = shortsTopY - 60; const headY = jerseyTopY - 15; 
            ctx.fillStyle = player.skinColor; ctx.beginPath(); ctx.roundRect(centerX - 15, legTopY, 10, 50, 5); ctx.roundRect(centerX + 5, legTopY, 10, 50, 5); ctx.fill();
            ctx.fillStyle = '#1f2937'; ctx.beginPath(); ctx.roundRect(centerX - 20, bootTopY, 20, 10, [0,0,5,5]); ctx.roundRect(centerX, bootTopY, 20, 10, [0,0,5,5]); ctx.fill();
            ctx.fillStyle = '#fff'; ctx.fillRect(centerX - 18, bootTopY+3, 8, 2); ctx.fillRect(centerX + 2, bootTopY+3, 8, 2);
            ctx.fillStyle = player.shortsColor; ctx.beginPath(); ctx.roundRect(centerX - 20, shortsTopY, 40, 30, [5,5,5,5]); ctx.fill();
            ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fillRect(centerX-20, shortsTopY, 4, 30); ctx.fillRect(centerX+16, shortsTopY, 4, 30);
            ctx.fillStyle = player.jerseyColor; ctx.beginPath(); ctx.roundRect(centerX - 25, jerseyTopY, 50, 60, 10); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.beginPath(); ctx.moveTo(centerX-25, jerseyTopY); ctx.lineTo(centerX+25, jerseyTopY); ctx.lineTo(centerX-25, jerseyTopY+60); ctx.fill();
            ctx.fillStyle = 'white'; ctx.font = 'bold 22px Nunito'; ctx.textAlign = 'center'; ctx.fillText('10', centerX, jerseyTopY + 38);
            ctx.fillStyle = player.skinColor; ctx.beginPath(); ctx.arc(centerX - 10, shortsBottomY + 5, 6, 0, Math.PI*2); ctx.arc(centerX + 10, shortsBottomY + 5, 6, 0, Math.PI*2); ctx.fill();
            const headWidth = player.headRadius * 2; const headHeight = player.headRadius * 2.3; const facePath = new Path2D(); facePath.ellipse(centerX, headY, headWidth / 2, headHeight / 2, 0, 0, Math.PI * 2);
            ctx.save(); ctx.clip(facePath); 
            if (userFaceImage) { ctx.drawImage(userFaceImage, 0, 0, userFaceImage.width, userFaceImage.height, centerX - headWidth * 0.6, headY - headHeight * 0.6, headWidth * 1.2, headHeight * 1.2); } 
            else {
                ctx.fillStyle = player.skinColor; ctx.fill(facePath);
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(centerX - 10, headY - 5, 8, 0, Math.PI*2); ctx.arc(centerX + 10, headY - 5, 8, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(centerX - 10, headY - 5, 3, 0, Math.PI*2); ctx.arc(centerX + 10, headY - 5, 3, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.beginPath(); ctx.arc(centerX, headY + 15, 8, 0, Math.PI, false); ctx.stroke();
            }
            ctx.restore(); ctx.lineWidth = 4; ctx.strokeStyle = '#333'; ctx.stroke(facePath);
        }

        function drawBall() {
            ctx.save(); ctx.translate(ball.x, ball.y); ctx.rotate(ball.rotation);
            ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.arc(3, 3, ball.radius, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, 0, ball.radius, 0, Math.PI * 2); ctx.fill();
            const gradient = ctx.createRadialGradient(-ball.radius/3, -ball.radius/3, 0, 0, 0, ball.radius * 1.5); gradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)'); gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
            ctx.fillStyle = gradient; ctx.fill();
            ctx.fillStyle = '#333'; for(let i=0; i<6; i++) { ctx.beginPath(); const angle = (Math.PI * 2 / 12) * (i * 2 + 1); ctx.arc(Math.cos(angle) * ball.radius * 0.5, Math.sin(angle) * ball.radius * 0.5, 7, 0, Math.PI*2); ctx.fill(); }
            ctx.lineWidth = 2; ctx.strokeStyle = '#000'; ctx.beginPath(); ctx.arc(0, 0, ball.radius, 0, Math.PI * 2); ctx.stroke(); ctx.restore();
        }
        
        function drawObstacle(obs) {
            ctx.save(); ctx.translate(obs.x, obs.y); ctx.rotate(obs.rotation);
            if (obs.type === 'whistle') {
                ctx.fillStyle = '#9ca3af'; ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 2; ctx.beginPath(); ctx.rect(-15, -10, 25, 20); ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-15, 0); ctx.lineTo(-25, -5); ctx.lineTo(-25, 5); ctx.lineTo(-15, 0); ctx.fill(); ctx.stroke(); ctx.fillStyle = '#d1d5db'; ctx.beginPath(); ctx.arc(0, 0, 6, 0, Math.PI*2); ctx.fill();
            } else if (obs.type === 'bottle') {
                ctx.fillStyle = '#3b82f6'; ctx.strokeStyle = '#1e3a8a'; ctx.lineWidth = 2; ctx.beginPath(); ctx.roundRect(-10, -20, 20, 40, 5); ctx.fill(); ctx.stroke(); ctx.fillStyle = '#111827'; ctx.fillRect(-8, -25, 16, 5); ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fillRect(-10, -5, 20, 5);
            } else if (obs.type === 'boot') {
                ctx.fillStyle = '#1f2937'; ctx.beginPath(); ctx.roundRect(-25, -10, 40, 20, [10, 10, 5, 5]); ctx.fill(); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(-10, -5); ctx.lineTo(-15, 5); ctx.moveTo(-5, -5); ctx.lineTo(-10, 5); ctx.stroke();
            } else {
                const isRed = obs.type === 'card_red'; ctx.fillStyle = isRed ? '#dc2626' : '#facc15'; ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.fillRect(-15, -20, 30, 40); ctx.strokeRect(-15, -20, 30, 40);
            }
            ctx.restore();
        }
        function createParticles(x, y, count, color, minRadius = 2) { for (let i = 0; i < count; i++) { particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 12, vy: (Math.random() - 1.5) * 8, radius: Math.random() * 3 + minRadius, color: color, life: 30 + Math.random() * 20, alpha: 1 }); } }
        function handleInput(clientX) { let newX = clientX; if (newX < 40) newX = 40; if (newX > canvas.width - 40) newX = canvas.width - 40; player.x += (newX - player.x) * PLAYER_SMOOTHING_FACTOR; }
        canvas.addEventListener('mousemove', (e) => handleInput(e.clientX)); canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleInput(e.touches[0].clientX); }, { passive: false });
        window.addEventListener('keydown', (e) => { if(e.key === "ArrowLeft" || e.key === "q") player.x = Math.max(40, player.x - 20); if(e.key === "ArrowRight" || e.key === "d") player.x = Math.min(canvas.width - 40, player.x + 20); });

        /** --- SCORES LOCAL & WORLD --- **/
        const SCORE_KEY = 'tete_dor_highscores';
        let currentTab = 'local';

        function loadLocalScores() { try { return JSON.parse(localStorage.getItem(SCORE_KEY)) || []; } catch { return []; } }
        
        async function saveScore(name, score) {
            // 1. Local
            let scores = loadLocalScores(); scores.push({ name: name || "Anonyme", score: score }); scores.sort((a, b) => b.score - a.score); scores = scores.slice(0, 10); localStorage.setItem(SCORE_KEY, JSON.stringify(scores));
            // 2. World (Firebase)
            if (isFirebaseReady) {
                try {
                    const { collection, addDoc } = window.firebaseModules;
                    // On √©crit dans une collection simple "scores"
                    await addDoc(collection(db, 'scores'), { name: name || "Anonyme", score: score, timestamp: Date.now() });
                } catch (e) { console.error("Erreur sauvegarde cloud:", e); }
            }
        }
        
        window.switchTab = function(tab) {
            currentTab = tab;
            document.getElementById('tabLocal').className = tab === 'local' ? 'tab-btn p-3 flex-1 font-bold text-gray-800 cursor-pointer border-b-4 border-blue-500 bg-white' : 'tab-btn p-3 flex-1 font-bold text-gray-500 cursor-pointer border-b-4 border-transparent hover:bg-gray-100';
            document.getElementById('tabWorld').className = tab === 'world' ? 'tab-btn p-3 flex-1 font-bold text-gray-800 cursor-pointer border-b-4 border-blue-500 bg-white' : 'tab-btn p-3 flex-1 font-bold text-gray-500 cursor-pointer border-b-4 border-transparent hover:bg-gray-100';
            renderScores();
        };

        async function renderScores() {
    const container = document.getElementById('scoresTable');
    container.innerHTML = '<div class="flex justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>';
    
    if (currentTab === 'local') {
        const scores = loadLocalScores();
        displayScoresList(scores, container);
    } else {
        // On attend un tout petit peu si Firebase n'est pas encore totalement pr√™t
        if (!isFirebaseReady) {
            // Tentative de reconnexion manuelle si besoin
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        if (isFirebaseReady) {
            try {
                const { collection, getDocs, query, orderBy, limit } = window.firebaseModules;
                const q = query(collection(db, 'scores'), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                const scores = querySnapshot.docs.map(doc => doc.data());
                displayScoresList(scores, container);
            } catch (e) {
                console.error("Erreur Firestore:", e);
                container.innerHTML = `<p class="text-center p-4 text-red-500 text-sm">Erreur: ${e.message}</p>`;
            }
        } else {
            container.innerHTML = '<p class="text-center p-4 text-gray-500">Connexion au serveur impossible...</p>';
        }
    }
}

        function displayScoresList(scores, container) {
            let html = '<table class="w-full border-collapse"><thead><tr class="text-gray-500 text-sm border-b"><th class="p-3 text-center">#</th><th class="p-3 text-left">JOUEUR</th><th class="p-3 text-right">SCORE</th></tr></thead><tbody>';
            if (scores.length === 0) { html += `<tr><td colspan="3" class="p-8 text-center text-gray-400 italic">Aucun score pour le moment.<br>Sois le premier !</td></tr>`; } 
            else {
                scores.forEach((s, i) => { 
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1);
                    const rowClass = i < 3 ? 'bg-yellow-50 font-bold' : (i % 2 === 0 ? 'bg-white' : 'bg-gray-50');
                    html += `<tr class="${rowClass} border-b border-gray-100"><td class="p-3 text-center">${medal}</td><td class="p-3 truncate max-w-[150px]">${s.name}</td><td class="p-3 text-right text-blue-600 font-mono text-lg">${s.score}</td></tr>`; 
                });
            }
            container.innerHTML = html + '</tbody></table>';
        }

        function displayHighScores() { document.getElementById('scoresModal').classList.remove('hidden'); switchTab('local'); }
        function endGame() {
            gameRunning = false; hudLayer.classList.add('hidden'); gameOverScreen.classList.remove('hidden'); finalScoreDisplay.textContent = score;
            const name = playerNameInput.value.trim() || "Joueur"; if(score > 0) saveScore(name, score);
        }

        document.getElementById('startBtn').addEventListener('click', () => { startScreen.classList.add('hidden'); hudLayer.classList.remove('hidden'); initGame(); });
        document.getElementById('restartBtn').addEventListener('click', () => { gameOverScreen.classList.add('hidden'); hudLayer.classList.remove('hidden'); initGame(); });
        document.getElementById('changeFaceBtn').addEventListener('click', () => { gameOverScreen.classList.add('hidden'); startScreen.classList.remove('hidden'); player.x = canvas.width / 2; });
        document.getElementById('showScoresBtn').addEventListener('click', displayHighScores);
        document.getElementById('closeScoresModal').addEventListener('click', () => { document.getElementById('scoresModal').classList.add('hidden'); });
        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { const img = new Image(); img.onload = () => { userFaceImage = img; facePreview.src = ev.target.result; facePreview.classList.remove('hidden'); placeholderFace.classList.add('hidden'); }; img.src = ev.target.result; }; reader.readAsDataURL(file); }
        });

        initCustomizationUI(); resize(); updateMusicButtonUI(); requestAnimationFrame(masterLoop); player.x = canvas.width / 2;
    </script>
</body>
</html>
