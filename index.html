<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T√™te d'Or - Arcade Football</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions to global scope for the game logic
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, getFirestore, collection, addDoc, getDocs };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
            touch-action: none;
            background-color: #222;
            user-select: none;
            -webkit-user-select: none;
        }

        h1, h2, .arcade-font {
            font-family: 'Fredoka One', cursive;
        }

        .bg-field {
            background: linear-gradient(to bottom, #7dd3fc 0%, #34d399 20%, #10b981 80%, #059669 100%);
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .interactive {
            pointer-events: auto;
        }

        .hidden {
            display: none !important;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 4px solid #f9fafb;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            border-radius: 1.5rem;
            max-height: 90vh;
            overflow-y: auto;
        }

        .btn-primary {
            transition: all 0.15s ease-out;
            border: 3px solid #14532d;
            background-image: linear-gradient(to bottom, #4ade80, #22c55e);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .btn-primary:active {
            box-shadow: none;
            transform: translateY(3px);
            border-bottom: 3px solid #14532d;
        }

        /* --- STYLES DU MASQUE VISAGE (Simple Ovale) --- */
        .face-preview-wrapper {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto;
        }

        .face-mask-clip {
            width: 100%;
            height: 100%;
            clip-path: ellipse(45% 55% at 50% 50%); /* Ovale simple */
            background-color: #e5e7eb;
            overflow: hidden;
            position: relative;
        }

        .face-mask-clip img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .face-guide-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        .score-row:nth-child(odd) {
            background-color: #f3f4f6;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(0,0,0,0.1);
            transition: transform 0.2s, border-color 0.2s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border: 3px solid #000;
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        /* Tabs for Scoreboard */
        .tab-btn {
            padding: 10px;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            font-weight: bold;
            color: #6b7280;
            flex: 1;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom: 4px solid #2563eb;
        }
    </style>
</head>
<body class="bg-field text-slate-800">

    <!-- Canvas du Jeu -->
    <canvas id="gameCanvas"></canvas>

    <!-- √âcran d'accueil / Customisation -->
    <div id="startScreen" class="ui-layer interactive">
        <div class="glass-panel p-6 max-w-md w-[95%] text-center">
            <h1 class="text-4xl sm:text-5xl text-green-700 mb-2 arcade-font drop-shadow-lg">T√äTE D'OR</h1>
            <p class="text-gray-600 mb-4 text-sm sm:text-base">Jongle avec ton visage, √©vite les impacts !</p>

            <div class="flex gap-4 justify-center items-start mb-4">
                
                <!-- Photo Upload -->
                <div class="relative group">
                    <div class="face-preview-wrapper">
                        <!-- Le conteneur qui coupe l'image (Ovale simple) -->
                        <div class="face-mask-clip shadow-xl bg-gray-200">
                            <img id="facePreview" src="" alt="Ton visage" class="hidden">
                            <div id="placeholderFace" class="w-full h-full flex items-center justify-center text-4xl text-gray-400">
                                
                            </div>
                        </div>
                        
                        <!-- Le GUIDE visuel (Ovale simple) -->
                        <svg class="face-guide-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
                            <ellipse cx="50" cy="50" rx="45" ry="55" fill="none" stroke="#eab308" stroke-width="3" stroke-dasharray="8,4" />
                            <!-- Yeux -->
                            <ellipse cx="35" cy="45" rx="5" ry="3" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1.5" stroke-dasharray="2,2" />
                            <ellipse cx="65" cy="45" rx="5" ry="3" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1.5" stroke-dasharray="2,2" />
                            <!-- Bouche -->
                            <path d="M 40,70 Q 50,75 60,70" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="1.5" stroke-dasharray="2,2" />
                        </svg>
                    </div>

                    <label for="photoInput" class="absolute -bottom-2 -right-2 bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-full cursor-pointer shadow-xl transition transform active:scale-95 z-30">
                        üì∏
                    </label>
                    <input type="file" id="photoInput" accept="image/*" capture="user">
                </div>

                <!-- Customisation Controls -->
                <div class="flex flex-col gap-3 text-left bg-white/50 p-3 rounded-xl border border-white">
                    <div>
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1">Maillot</span>
                        <div class="flex gap-2" id="jerseyColors"></div>
                    </div>
                    <div>
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1">Short</span>
                        <div class="flex gap-2" id="shortsColors"></div>
                    </div>
                </div>
            </div>

            <input type="text" id="playerNameInput" placeholder="Ton nom de joueur" class="w-full p-2 mb-4 border-2 border-gray-300 rounded-lg text-center font-bold focus:border-blue-500 transition" maxlength="15">

            <div class="flex gap-2 mb-4">
                <button id="toggleMusicBtn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg font-bold text-sm transition">
                    üéµ Musique: OFF
                </button>
            </div>

            <button id="startBtn" class="w-full btn-primary text-white text-xl py-3 rounded-xl font-bold shadow-[0_6px_0_rgb(21,128,61)] transition mb-2 arcade-font">
                JOUER LE MATCH
            </button>
            <button id="showScoresBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-base py-2 rounded-xl font-bold shadow-[0_4px_0_rgb(29,78,216)] active:shadow-none active:translate-y-[4px] transition">
                üèÜ Meilleurs Scores
            </button>
        </div>
    </div>

    <!-- Interface en jeu -->
    <div id="hudLayer" class="ui-layer hidden !justify-start !items-start p-4">
        <div class="flex justify-between w-full items-start">
            <div class="text-4xl text-white font-black drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] arcade-font">
                <span id="scoreDisplay">0</span>
            </div>
            <div class="flex flex-col items-end gap-2">
                <div id="levelDisplay" class="text-xl text-yellow-300 font-bold drop-shadow-lg bg-black/40 px-4 py-1 rounded-full">
                    NIVEAU 1
                </div>
                <button id="muteBtnGame" class="bg-black/40 text-white p-2 rounded-full hover:bg-black/60 transition">
                    üîä
                </button>
            </div>
        </div>
    </div>

    <!-- √âcran Game Over -->
    <div id="gameOverScreen" class="ui-layer interactive hidden">
        <div class="glass-panel p-8 max-w-sm w-[90%] text-center">
            <h2 class="text-5xl text-red-600 mb-4 arcade-font drop-shadow-md">FIN DU MATCH</h2>
            <p class="text-gray-700 text-2xl mb-6">Score Final: <span id="finalScore" class="font-bold text-red-600">0</span></p>
            
            <div id="highScoreContainer" class="mb-6 text-yellow-600 font-bold text-lg hidden">
                NOUVEAU RECORD ! üèÜ
            </div>

            <button id="restartBtn" class="w-full btn-primary bg-blue-500 text-white text-xl py-3 rounded-xl font-bold shadow-[0_6px_0_rgb(29,78,216)] transition mb-3 arcade-font">
                REJOUER
            </button>
            <button id="shareBtn" class="w-full bg-teal-500 hover:bg-teal-600 text-white text-lg py-3 rounded-xl font-bold shadow-[0_4px_0_rgb(13,148,136)] active:shadow-none active:translate-y-[4px] transition mb-3">
                Partager
            </button>
            <button id="changeFaceBtn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 text-lg py-2 rounded-xl font-bold transition">
                Menu Principal
            </button>
        </div>
    </div>

    <!-- Modal Tableau des Scores -->
    <div id="scoresModal" class="modal hidden interactive">
        <div class="glass-panel modal-content p-6 max-w-lg w-[90%] text-center">
            <h2 class="text-3xl text-blue-600 mb-4 arcade-font">CLASSEMENT</h2>
            
            <!-- TABS -->
            <div class="flex border-b mb-4">
                <div id="tabLocal" class="tab-btn active" onclick="switchTab('local')">LOCAL</div>
                <div id="tabWorld" class="tab-btn" onclick="switchTab('world')">MONDE üåç</div>
            </div>

            <div id="scoresTable" class="text-left min-h-[200px]">
                <!-- Scores injected here -->
            </div>
            
            <button id="closeScoresModal" class="mt-6 w-full bg-red-500 hover:bg-red-600 text-white text-lg py-3 rounded-xl font-bold transition">
                Fermer
            </button>
        </div>
    </div>

    <script>
        /**
         * --- FIREBASE SETUP ---
         */
        let db, auth;
        let isFirebaseReady = false;
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-soccer-app';

        async function initFirebase() {
            try {
                if (window.firebaseModules && typeof __firebase_config !== 'undefined') {
                    const { initializeApp, getAuth, signInAnonymously, getFirestore } = window.firebaseModules;
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         // Custom token flow if available
                         const { signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                         await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    isFirebaseReady = true;
                    console.log("Firebase initialized");
                }
            } catch (e) {
                console.error("Firebase init error:", e);
                // Fallback to local only mode silently
            }
        }

        // Trigger init immediately
        initFirebase();

        /**
         * --- AUDIO ENGINE ---
         */
        const AudioEngine = {
            ctx: null, isPlaying: false, osc: null, gain: null, nextNoteTime: 0, noteIndex: 0, tempo: 0.15,
            melody: [261.63, 261.63, 293.66, 261.63, 349.23, 329.63, 0, 261.63, 261.63, 293.66, 261.63, 392.00, 349.23, 0, 329.63, 329.63, 440.00, 392.00, 349.23, 329.63, 293.66, 0],
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            toggle() {
                this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                this.isPlaying = !this.isPlaying;
                if (this.isPlaying) { this.nextNoteTime = this.ctx.currentTime; this.scheduler(); } 
                else { if(this.osc) { this.osc.stop(); this.osc.disconnect(); this.osc = null; } clearTimeout(this.timerID); }
                return this.isPlaying;
            },
            playTone(freq, time) {
                if(freq <= 0) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square'; osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.05, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(time); osc.stop(time + 0.15);
            },
            scheduler() {
                if (!this.isPlaying) return;
                while (this.nextNoteTime < this.ctx.currentTime + 0.1) {
                    this.playTone(this.melody[this.noteIndex % this.melody.length], this.nextNoteTime);
                    this.nextNoteTime += this.tempo;
                    this.noteIndex++;
                }
                this.timerID = setTimeout(() => this.scheduler(), 25);
            }
        };

        /**
         * CONFIGURATION
         */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Refs
        const startScreen = document.getElementById('startScreen');
        const hudLayer = document.getElementById('hudLayer');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const finalScoreDisplay = document.getElementById('finalScore');
        const photoInput = document.getElementById('photoInput');
        const facePreview = document.getElementById('facePreview');
        const placeholderFace = document.getElementById('placeholderFace');
        const levelDisplay = document.getElementById('levelDisplay');
        const playerNameInput = document.getElementById('playerNameInput');
        const toggleMusicBtn = document.getElementById('toggleMusicBtn');
        const muteBtnGame = document.getElementById('muteBtnGame');

        // Game State
        let gameRunning = false;
        let score = 0;
        let animationId;
        let lastTime = 0;
        let difficultyLevel = 1;
        let userFaceImage = null; 
        let playerHitTimer = 0;
        
        // Physics
        const GRAVITY = 0.55; 
        const AIR_RESISTANCE = 0.99;
        const BOUNCE_FORCE = -15; 
        const PLAYER_RECOIL_FORCE = 15; 
        const PLAYER_SMOOTHING_FACTOR = 0.5;

        // Entities
        let player = {
            x: 0,
            y: 0,
            width: 80,
            height: 140,
            headRadius: 35,
            vx: 0,
            jerseyColor: '#3b82f6',
            shortsColor: '#ffffff'
        };

        let ball = { x: 0, y: 0, radius: 20, vx: 0, vy: 0, rotation: 0 };
        let obstacles = [];
        let particles = [];
        
        const jerseyColors = ['#3b82f6', '#ef4444', '#22c55e', '#eab308', '#a855f7', '#111827'];
        const shortsColors = ['#ffffff', '#1f2937', '#3b82f6', '#ef4444'];

        function initCustomizationUI() {
            const jContainer = document.getElementById('jerseyColors');
            const sContainer = document.getElementById('shortsColors');
            jerseyColors.forEach(color => {
                const el = document.createElement('div');
                el.className = `color-option ${color === player.jerseyColor ? 'selected' : ''}`;
                el.style.backgroundColor = color;
                el.onclick = () => { player.jerseyColor = color; updateSelection(jContainer, el); };
                jContainer.appendChild(el);
            });
            shortsColors.forEach(color => {
                const el = document.createElement('div');
                el.className = `color-option ${color === player.shortsColor ? 'selected' : ''}`;
                el.style.backgroundColor = color;
                el.onclick = () => { player.shortsColor = color; updateSelection(sContainer, el); };
                sContainer.appendChild(el);
            });
        }

        function updateSelection(container, selectedEl) {
            Array.from(container.children).forEach(c => c.classList.remove('selected'));
            selectedEl.classList.add('selected');
        }

        function setPlayerY() {
            player.y = canvas.height - 40; 
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            setPlayerY();
        }
        window.addEventListener('resize', resize);
        
        function updateMusicButtonUI() {
            const text = AudioEngine.isPlaying ? "üéµ Musique: ON" : "üéµ Musique: OFF";
            toggleMusicBtn.textContent = text;
            toggleMusicBtn.className = AudioEngine.isPlaying ? "flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold text-sm transition" : "flex-1 bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg font-bold text-sm transition";
            muteBtnGame.textContent = AudioEngine.isPlaying ? "üîä" : "üîá";
        }
        toggleMusicBtn.addEventListener('click', () => { AudioEngine.toggle(); updateMusicButtonUI(); });
        muteBtnGame.addEventListener('click', () => { AudioEngine.toggle(); updateMusicButtonUI(); });

        function initGame() {
            score = 0; difficultyLevel = 1; scoreDisplay.textContent = "0";
            levelDisplay.textContent = "NIVEAU 1";
            levelDisplay.className = "text-xl text-yellow-300 font-bold drop-shadow-lg bg-black/40 px-4 py-1 rounded-full";
            player.x = canvas.width / 2;
            setPlayerY(); 
            resetBall();
            obstacles = []; particles = []; gameRunning = true; lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function resetBall() {
            const side = Math.random() < 0.5 ? 'left' : 'right';
            ball.x = side === 'left' ? -30 : canvas.width + 30;
            ball.y = canvas.height / 3; 
            const speedX = 6 + Math.random() * 4;
            ball.vx = side === 'left' ? speedX : -speedX;
            ball.vy = -8 - Math.random() * 5; 
            ball.rotation = 0;
        }

        function gameLoop(timestamp) {
            if (!gameRunning) return;
            const dt = timestamp - lastTime; lastTime = timestamp;
            update(); draw();
            animationId = requestAnimationFrame(gameLoop);
        }

        function update() {
            ball.vy += GRAVITY; ball.vx *= AIR_RESISTANCE;
            ball.x += ball.vx; ball.y += ball.vy; ball.rotation += ball.vx * 0.05;

            if (ball.x - ball.radius < 0) { ball.x = ball.radius; ball.vx *= -0.8; } 
            else if (ball.x + ball.radius > canvas.width) { ball.x = canvas.width - ball.radius; ball.vx *= -0.8; }
            if (ball.y - ball.radius > canvas.height - 40) { endGame(); }

            const headCenterY = player.y - 155; 
            const dx = ball.x - player.x; const dy = ball.y - headCenterY;
            const distance = Math.sqrt(dx*dx + dy*dy);
            const minDist = ball.radius + player.headRadius * 0.8; 

            if (distance < minDist && ball.vy > 0) { 
                const impactRatio = dx / (player.headRadius * 1.5); 
                ball.vy = BOUNCE_FORCE; ball.vx = impactRatio * 15; 
                ball.y = headCenterY - minDist - 2; 
                score++; scoreDisplay.textContent = score;
                createParticles(ball.x, ball.y + ball.radius, 15, '#ffffff', 5);
                createParticles(ball.x, ball.y + ball.radius, 7, '#fbbf24', 3);
                checkDifficulty();
            }
            
            if(playerHitTimer > 0) playerHitTimer--;

            if (Math.random() < 0.008 * difficultyLevel) spawnObstacle();

            obstacles.forEach((obs, index) => {
                obs.x += obs.vx; obs.y += obs.vy; obs.rotation += obs.rotSpeed;
                if (obs.x < -100 || obs.x > canvas.width + 100 || obs.y > canvas.height + 100) { obstacles.splice(index, 1); return; }
                const dxB = ball.x - obs.x; const dyB = ball.y - obs.y;
                if (Math.sqrt(dxB * dxB + dyB * dyB) < ball.radius + 20) { 
                    createParticles(ball.x, ball.y, 8, '#9ca3af', 3); 
                    ball.vx = (Math.random() - 0.5) * 25; ball.vy = (Math.random() - 0.5) * 20; 
                    obstacles.splice(index, 1); return;
                }
                const playerBodyTop = player.y - 140; const playerBodyBottom = player.y - 5;
                if (obs.x > player.x - 30 && obs.x < player.x + 30 && obs.y > playerBodyTop && obs.y < playerBodyBottom) {
                    if (playerHitTimer === 0) {
                        createParticles(obs.x, obs.y, 15, '#ef4444', 4);
                        player.vx = obs.vx > 0 ? -PLAYER_RECOIL_FORCE : PLAYER_RECOIL_FORCE; 
                        playerHitTimer = 30; setTimeout(() => player.vx = 0, 100); 
                    }
                    obstacles.splice(index, 1); return;
                }
            });
            
            player.x += player.vx;
            if (player.x < 40) player.x = 40; if (player.x > canvas.width - 40) player.x = canvas.width - 40;

            particles.forEach((p, index) => {
                p.x += p.vx; p.y += p.vy; p.life--; p.alpha = p.life / 30; p.radius *= 0.95;
                if (p.life <= 0) particles.splice(index, 1);
            });
        }

        function checkDifficulty() {
            const newLevel = Math.min(10, Math.floor(score / 10) + 1);
            if (newLevel !== difficultyLevel) {
                difficultyLevel = newLevel;
                levelDisplay.textContent = "NIVEAU " + difficultyLevel;
                const levelColors = ['text-yellow-300', 'text-orange-400', 'text-red-500', 'text-pink-500', 'text-purple-500', 'text-indigo-400', 'text-cyan-300', 'text-lime-300', 'text-amber-500', 'text-rose-600'];
                levelDisplay.className = `text-xl font-bold drop-shadow-lg bg-black/40 px-4 py-1 rounded-full ${levelColors[newLevel - 1]}`;
            }
        }

        function spawnObstacle() {
            const side = Math.random() < 0.5 ? 'left' : 'right';
            const r = Math.random();
            let type;
            if (r < 0.25) type = 'card_red'; else if (r < 0.5) type = 'card_yellow'; else if (r < 0.7) type = 'boot'; else if (r < 0.85) type = 'whistle'; else type = 'bottle';
            
            const baseSpeed = 3; const speedMultiplier = 1 + (difficultyLevel - 1) * 0.4;
            obstacles.push({
                type: type,
                x: side === 'left' ? -30 : canvas.width + 30,
                y: Math.random() * (canvas.height - 250) + 50, 
                vx: side === 'left' ? (baseSpeed + Math.random() * speedMultiplier) : -(baseSpeed + Math.random() * speedMultiplier),
                vy: (Math.random() - 0.5) * 2, rotation: 0, rotSpeed: (Math.random() - 0.5) * 0.15
            });
        }

        function draw() {
            ctx.fillStyle = '#10b981'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'rgba(255,255,255,0.7)'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(canvas.width / 2, canvas.height - 40); ctx.lineTo(canvas.width / 2, 0); ctx.stroke();
            ctx.beginPath(); ctx.arc(canvas.width / 2, canvas.height - 40, 80, Math.PI, Math.PI * 2, false); ctx.stroke();
            ctx.fillStyle = '#059669'; ctx.fillRect(0, canvas.height - 40, canvas.width, 40);

            if (playerHitTimer % 6 < 3) drawPlayer();
            obstacles.forEach(drawObstacle); drawBall();
            particles.forEach(p => {
                ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); ctx.fill();
                ctx.globalAlpha = 1;
            });
        }

        function drawPlayer() {
            const centerX = player.x; const groundY = player.y;
            ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.ellipse(centerX, groundY, 30, 8, 0, 0, Math.PI * 2); ctx.fill();

            const legColor = '#fca5a5'; const bootColor = '#1f2937';
            const bootTopY = groundY - 10; const legTopY = bootTopY - 50; const shortsBottomY = legTopY + 10; const shortsTopY = shortsBottomY - 30; const jerseyTopY = shortsTopY - 60; const headY = jerseyTopY - 15; 
            
            ctx.fillStyle = legColor; ctx.beginPath(); ctx.roundRect(centerX - 15, legTopY, 10, 50, 5); ctx.roundRect(centerX + 5, legTopY, 10, 50, 5); ctx.fill();
            ctx.fillStyle = bootColor; ctx.beginPath(); ctx.roundRect(centerX - 20, bootTopY, 20, 10, [0,0,5,5]); ctx.roundRect(centerX, bootTopY, 20, 10, [0,0,5,5]); ctx.fill();
            ctx.fillStyle = player.shortsColor; ctx.beginPath(); ctx.roundRect(centerX - 20, shortsTopY, 40, 30, [5,5,0,0]); ctx.fill();
            ctx.fillStyle = player.jerseyColor; ctx.beginPath(); ctx.roundRect(centerX - 25, jerseyTopY, 50, 60, 10); ctx.fill();
            ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.beginPath(); ctx.roundRect(centerX - 25, jerseyTopY, 50, 60, 10); ctx.fill();
            ctx.fillStyle = 'white'; ctx.font = 'bold 20px Nunito'; ctx.textAlign = 'center'; ctx.fillText('10', centerX, jerseyTopY + 30);
            ctx.fillStyle = legColor; ctx.beginPath(); ctx.arc(centerX - 35, shortsBottomY - 20, 8, 0, Math.PI*2); ctx.arc(centerX + 35, shortsBottomY - 20, 8, 0, Math.PI*2); ctx.fill();

            // --- T√äTE SIMPLE (Ovale, sans oreilles) ---
            const headWidth = player.headRadius * 2;
            const headHeight = player.headRadius * 2.3;
            const headX = centerX;
            const headYPos = headY;

            const facePath = new Path2D();
            facePath.ellipse(headX, headYPos, headWidth / 2, headHeight / 2, 0, 0, Math.PI * 2);
            
            ctx.save();
            ctx.clip(facePath); 

            if (userFaceImage) {
                const drawW = headWidth * 1.2;
                const drawH = headHeight * 1.2;
                const drawX = headX - drawW / 2;
                const drawY = headYPos - drawH / 2;
                ctx.drawImage(userFaceImage, 0, 0, userFaceImage.width, userFaceImage.height, drawX, drawY, drawW, drawH);
            } else {
                ctx.fillStyle = legColor; 
                ctx.fill(facePath);
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(centerX - 10, headY - 5, 8, 0, Math.PI*2); ctx.arc(centerX + 10, headY - 5, 8, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(centerX - 10, headY - 5, 3, 0, Math.PI*2); ctx.arc(centerX + 10, headY - 5, 3, 0, Math.PI*2); ctx.fill();
            }
            ctx.restore();

            ctx.lineWidth = 4; ctx.strokeStyle = '#333'; ctx.stroke(facePath);
        }

        function drawBall() {
            ctx.save(); ctx.translate(ball.x, ball.y); ctx.rotate(ball.rotation);
            ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.arc(3, 3, ball.radius, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, 0, ball.radius, 0, Math.PI * 2); ctx.fill();
            const gradient = ctx.createRadialGradient(-ball.radius/3, -ball.radius/3, 0, 0, 0, ball.radius * 1.5);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)'); gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
            ctx.fillStyle = gradient; ctx.fill();
            ctx.fillStyle = '#333'; const pentagonSize = 7;
            for(let i=0; i<6; i++) {
                ctx.beginPath();
                const angle = (Math.PI * 2 / 12) * (i * 2 + 1);
                const x = Math.cos(angle) * (ball.radius * 0.5); const y = Math.sin(angle) * (ball.radius * 0.5);
                ctx.arc(x, y, pentagonSize, 0, Math.PI*2); ctx.fill();
            }
            ctx.lineWidth = 2; ctx.strokeStyle = '#000'; ctx.beginPath(); ctx.arc(0, 0, ball.radius, 0, Math.PI * 2); ctx.stroke();
            ctx.restore();
        }
        
        function drawObstacle(obs) {
            ctx.save(); ctx.translate(obs.x, obs.y); ctx.rotate(obs.rotation);
            if (obs.type === 'whistle') {
                ctx.fillStyle = '#9ca3af'; ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.rect(-15, -10, 25, 20); ctx.fill(); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-15, 0); ctx.lineTo(-25, -5); ctx.lineTo(-25, 5); ctx.lineTo(-15, 0); ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#d1d5db'; ctx.beginPath(); ctx.arc(0, 0, 6, 0, Math.PI*2); ctx.fill();
            } else if (obs.type === 'bottle') {
                ctx.fillStyle = '#3b82f6'; ctx.strokeStyle = '#1e3a8a'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.roundRect(-10, -20, 20, 40, 5); ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#111827'; ctx.fillRect(-8, -25, 16, 5);
                ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fillRect(-10, -5, 20, 5);
            } else if (obs.type === 'boot') {
                ctx.fillStyle = '#1f2937'; ctx.beginPath(); ctx.roundRect(-25, -10, 40, 20, [10, 10, 5, 5]); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(-10, -5); ctx.lineTo(-15, 5); ctx.moveTo(-5, -5); ctx.lineTo(-10, 5); ctx.stroke();
            } else {
                const isRed = obs.type === 'card_red'; const color = isRed ? '#dc2626' : '#facc15'; 
                ctx.fillStyle = color; ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.fillRect(-15, -20, 30, 40); ctx.strokeRect(-15, -20, 30, 40);
            }
            ctx.restore();
        }

        function createParticles(x, y, count, color, minRadius = 2) {
            for (let i = 0; i < count; i++) {
                particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 12, vy: (Math.random() - 1.5) * 8, radius: Math.random() * 3 + minRadius, color: color, life: 30 + Math.random() * 20, alpha: 1 });
            }
        }

        function handleInput(clientX) {
            let newX = clientX;
            if (newX < 40) newX = 40; if (newX > canvas.width - 40) newX = canvas.width - 40;
            player.x += (newX - player.x) * PLAYER_SMOOTHING_FACTOR; 
        }

        canvas.addEventListener('mousemove', (e) => { if(gameRunning) handleInput(e.clientX); });
        canvas.addEventListener('touchmove', (e) => { if(gameRunning) { e.preventDefault(); handleInput(e.touches[0].clientX); } }, { passive: false });
        window.addEventListener('keydown', (e) => {
            if(!gameRunning) return;
            if(e.key === "ArrowLeft" || e.key === "q") player.x = Math.max(40, player.x - 20);
            if(e.key === "ArrowRight" || e.key === "d") player.x = Math.min(canvas.width - 40, player.x + 20);
        });

        // --- SCORING SYSTEM (LOCAL & WORLD) ---
        const SCORE_KEY = 'tete_dor_highscores';
        let currentTab = 'local';

        function loadLocalScores() { try { return JSON.parse(localStorage.getItem(SCORE_KEY)) || []; } catch { return []; } }
        
        async function saveScore(name, score) {
            // 1. Save Local
            let scores = loadLocalScores();
            scores.push({ name: name || "Anonyme", score: score });
            scores.sort((a, b) => b.score - a.score); 
            scores = scores.slice(0, 10);
            localStorage.setItem(SCORE_KEY, JSON.stringify(scores));

            // 2. Save World (if Firebase is ready)
            if (isFirebaseReady) {
                try {
                    const { collection, addDoc } = window.firebaseModules;
                    // Path Rule: /artifacts/{appId}/public/data/scores
                    await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'scores'), {
                        name: name || "Anonyme",
                        score: score,
                        timestamp: Date.now()
                    });
                } catch (e) {
                    console.error("Error saving to cloud:", e);
                }
            }
        }
        
        window.switchTab = function(tab) {
            currentTab = tab;
            document.getElementById('tabLocal').className = tab === 'local' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tabWorld').className = tab === 'world' ? 'tab-btn active' : 'tab-btn';
            renderScores();
        };

        async function renderScores() {
            const container = document.getElementById('scoresTable');
            container.innerHTML = '<p class="text-center p-4 text-gray-500">Chargement...</p>';
            
            let scores = [];

            if (currentTab === 'local') {
                scores = loadLocalScores();
            } else {
                // Fetch World Scores
                if (isFirebaseReady) {
                    try {
                        const { collection, getDocs } = window.firebaseModules;
                        const querySnapshot = await getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'scores'));
                        scores = querySnapshot.docs.map(doc => doc.data());
                        // Client-side sort (Rule 2 compliancy)
                        scores.sort((a, b) => b.score - a.score);
                        scores = scores.slice(0, 10); // Top 10
                    } catch (e) {
                        console.error("Fetch error:", e);
                        container.innerHTML = '<p class="text-center p-4 text-red-500">Erreur de connexion.</p>';
                        return;
                    }
                } else {
                    container.innerHTML = '<p class="text-center p-4 text-gray-500">Mode hors ligne.</p>';
                    return;
                }
            }

            let html = '<table class="w-full border-collapse"><thead><tr class="bg-blue-500 text-white arcade-font"><th class="p-2">#</th><th class="p-2 text-left">Nom</th><th class="p-2">Score</th></tr></thead><tbody>';
            
            if (scores.length === 0) {
                html += `<tr><td colspan="3" class="p-4 text-center text-gray-500 score-row">Aucun score enregistr√©.</td></tr>`;
            } else {
                scores.forEach((s, i) => { 
                    html += `<tr class="score-row"><td class="p-2 text-center font-bold">${i + 1}</td><td class="p-2">${s.name}</td><td class="p-2 text-center text-green-600 font-bold">${s.score}</td></tr>`; 
                });
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayHighScores() {
            document.getElementById('scoresModal').classList.remove('hidden');
            renderScores();
        }

        function endGame() {
            gameRunning = false; cancelAnimationFrame(animationId);
            hudLayer.classList.add('hidden'); gameOverScreen.classList.remove('hidden'); finalScoreDisplay.textContent = score;
            const name = playerNameInput.value.trim() || "Joueur"; if(score > 0) saveScore(name, score);
        }

        document.getElementById('startBtn').addEventListener('click', () => { startScreen.classList.add('hidden'); hudLayer.classList.remove('hidden'); initGame(); });
        document.getElementById('restartBtn').addEventListener('click', () => { gameOverScreen.classList.add('hidden'); hudLayer.classList.remove('hidden'); initGame(); });
        document.getElementById('changeFaceBtn').addEventListener('click', () => { gameOverScreen.classList.add('hidden'); startScreen.classList.remove('hidden'); });
        document.getElementById('showScoresBtn').addEventListener('click', displayHighScores);
        document.getElementById('closeScoresModal').addEventListener('click', () => { document.getElementById('scoresModal').classList.add('hidden'); });

        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        userFaceImage = img;
                        facePreview.src = ev.target.result;
                        facePreview.classList.remove('hidden');
                        placeholderFace.classList.add('hidden');
                    }
                    img.src = ev.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        initCustomizationUI(); resize(); updateMusicButtonUI();
    </script>
</body>
</html>
